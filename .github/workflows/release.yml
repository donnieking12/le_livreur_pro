name: Release Management

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      release_type:
        description: 'Release type'
        required: true
        default: 'minor'
        type: choice
        options:
        - patch
        - minor
        - major
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

env:
  FLUTTER_VERSION: '3.35.5'

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install semantic-release
      run: npm install -g semantic-release @semantic-release/changelog @semantic-release/git
      
    - name: Determine version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
          TAG="v$VERSION"
        else
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"
        echo "Release tag: $TAG"

  build-release-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: prepare-release
    strategy:
      matrix:
        platform: [android, web]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: Setup Java (Android)
      if: matrix.platform == 'android'
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Configure production environment
      run: |
        cp deployment/env/.env.production .env
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Build Android Release
      if: matrix.platform == 'android'
      run: |
        flutter build apk --release --split-per-abi
        flutter build appbundle --release
        
    - name: Build Web Release
      if: matrix.platform == 'web'
      run: |
        flutter build web --release --web-renderer canvaskit
        
    - name: Archive Android artifacts
      if: matrix.platform == 'android'
      uses: actions/upload-artifact@v4
      with:
        name: android-release-${{ needs.prepare-release.outputs.version }}
        path: |
          build/app/outputs/flutter-apk/*.apk
          build/app/outputs/bundle/release/*.aab
          
    - name: Archive Web artifacts
      if: matrix.platform == 'web'
      uses: actions/upload-artifact@v4
      with:
        name: web-release-${{ needs.prepare-release.outputs.version }}
        path: build/web/

  build-ios-release:
    name: Build iOS Release
    runs-on: macos-latest
    needs: prepare-release
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: Configure production environment
      run: |
        cp deployment/env/.env.production .env
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Install iOS dependencies
      run: |
        cd ios
        pod install
        
    - name: Build iOS Release
      run: |
        flutter build ios --release --no-codesign
        
    - name: Archive iOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-release-${{ needs.prepare-release.outputs.version }}
        path: build/ios/iphoneos/

  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: prepare-release
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Generate changelog
      id: changelog
      run: |
        # Get commits since last tag
        LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [[ -n "$LAST_TAG" ]]; then
          COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"- %s" --reverse)
        else
          COMMITS=$(git log --pretty=format:"- %s" --reverse)
        fi
        
        # Create changelog
        CHANGELOG=$(cat << EOF
        ## What's Changed
        
        $COMMITS
        
        **Full Changelog**: https://github.com/${{ github.repository }}/compare/$LAST_TAG...${{ needs.prepare-release.outputs.tag }}
        EOF
        )
        
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Save changelog
      run: |
        echo "${{ steps.changelog.outputs.changelog }}" > release-notes.md
        
    - name: Upload changelog
      uses: actions/upload-artifact@v4
      with:
        name: release-notes-${{ needs.prepare-release.outputs.version }}
        path: release-notes.md

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare-release, build-release-artifacts, build-ios-release, generate-changelog]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts/
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.prepare-release.outputs.tag }}
        name: Le Livreur Pro ${{ needs.prepare-release.outputs.version }}
        body_path: release-artifacts/release-notes-${{ needs.prepare-release.outputs.version }}/release-notes.md
        draft: false
        prerelease: ${{ github.event.inputs.prerelease == 'true' }}
        files: |
          release-artifacts/android-release-${{ needs.prepare-release.outputs.version }}/*.apk
          release-artifacts/android-release-${{ needs.prepare-release.outputs.version }}/*.aab
        token: ${{ secrets.GITHUB_TOKEN }}

  deploy-to-stores:
    name: Deploy to App Stores
    runs-on: ubuntu-latest
    needs: [prepare-release, create-github-release]
    if: github.event.inputs.prerelease != 'true'
    
    steps:
    - name: Trigger production deployment
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'cd.yml',
            ref: 'main',
            inputs: {
              environment: 'production'
            }
          });

  notify-release:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [prepare-release, create-github-release]
    if: always()
    
    steps:
    - name: Notify success
      if: needs.create-github-release.result == 'success'
      run: |
        echo "üéâ Release ${{ needs.prepare-release.outputs.version }} created successfully!"
        echo "üì± Android APK and AAB files are ready"
        echo "üçé iOS build is ready"
        echo "üåê Web build is ready"
        echo "üîó Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare-release.outputs.tag }}"
        
    - name: Notify failure
      if: needs.create-github-release.result == 'failure'
      run: |
        echo "‚ùå Release creation failed!"
        echo "Check the workflow logs for details."
        exit 1